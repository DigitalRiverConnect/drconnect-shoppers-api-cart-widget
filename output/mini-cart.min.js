/**
 * almond 0.2.5 Copyright (c) 2011-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

/*!
 *
 * Copyright 2009-2012 Kris Kowal under the terms of the MIT
 * license found at http://github.com/kriskowal/q/raw/master/LICENSE
 *
 * With parts by Tyler Close
 * Copyright 2007-2009 Tyler Close under the terms of the MIT X license found
 * at http://www.opensource.org/licenses/mit-license.html
 * Forked at ref_send.js version: 2009-05-11
 *
 * With parts by Mark Miller
 * Copyright (C) 2011 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 */

/**
 * An API Library for making JSON P calls without jQuery.
 * @author Christopher Pryce<cpryce@digitalriver.com>
 * 
 * Based on JSON and JSONP By Angus Croll
 * http://javascriptweblog.wordpress.com/2010/11/29/json-and-jsonp/
 * 
 * Copyright 2013 Digital River, Inc.
 *
 * Module definition
 * @dependency Q or an other library that supports CommonJS Promises/A API
 * @dependency underscore The underscore library, or another library that provides
 * a shim to map and forEach for supporting browsers still using ECMA 3.
 * 
 * jslint browser: true, nomen: true, sloppy: true 
 * using sloppy here for performance, but strict practices apply
 * 
 */

var requirejs,require,define;(function(e){function c(e,t){return f.call(e,t)}function h(e,t){var n,r,i,s,o,a,f,l,c,h,p=t&&t.split("/"),d=u.map,v=d&&d["*"]||{};if(e&&e.charAt(0)===".")if(t){p=p.slice(0,p.length-1),e=p.concat(e.split("/"));for(l=0;l<e.length;l+=1){h=e[l];if(h===".")e.splice(l,1),l-=1;else if(h===".."){if(l===1&&(e[2]===".."||e[0]===".."))break;l>0&&(e.splice(l-1,2),l-=2)}}e=e.join("/")}else e.indexOf("./")===0&&(e=e.substring(2));if((p||v)&&d){n=e.split("/");for(l=n.length;l>0;l-=1){r=n.slice(0,l).join("/");if(p)for(c=p.length;c>0;c-=1){i=d[p.slice(0,c).join("/")];if(i){i=i[r];if(i){s=i,o=l;break}}}if(s)break;!a&&v&&v[r]&&(a=v[r],f=l)}!s&&a&&(s=a,o=f),s&&(n.splice(0,o,s),e=n.join("/"))}return e}function p(t,r){return function(){return n.apply(e,l.call(arguments,0).concat([t,r]))}}function d(e){return function(t){return h(t,e)}}function v(e){return function(t){s[e]=t}}function m(n){if(c(o,n)){var r=o[n];delete o[n],a[n]=!0,t.apply(e,r)}if(!c(s,n)&&!c(a,n))throw new Error("No "+n);return s[n]}function g(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function y(e){return function(){return u&&u.config&&u.config[e]||{}}}var t,n,r,i,s={},o={},u={},a={},f=Object.prototype.hasOwnProperty,l=[].slice;r=function(e,t){var n,r=g(e),i=r[0];return e=r[1],i&&(i=h(i,t),n=m(i)),i?n&&n.normalize?e=n.normalize(e,d(t)):e=h(e,t):(e=h(e,t),r=g(e),i=r[0],e=r[1],i&&(n=m(i))),{f:i?i+"!"+e:e,n:e,pr:i,p:n}},i={require:function(e){return p(e)},exports:function(e){var t=s[e];return typeof t!="undefined"?t:s[e]={}},module:function(e){return{id:e,uri:"",exports:s[e],config:y(e)}}},t=function(t,n,u,f){var l,h,d,g,y,b=[],w;f=f||t;if(typeof u=="function"){n=!n.length&&u.length?["require","exports","module"]:n;for(y=0;y<n.length;y+=1){g=r(n[y],f),h=g.f;if(h==="require")b[y]=i.require(t);else if(h==="exports")b[y]=i.exports(t),w=!0;else if(h==="module")l=b[y]=i.module(t);else if(c(s,h)||c(o,h)||c(a,h))b[y]=m(h);else{if(!g.p)throw new Error(t+" missing "+h);g.p.load(g.n,p(f,!0),v(h),{}),b[y]=s[h]}}d=u.apply(s[t],b);if(t)if(l&&l.exports!==e&&l.exports!==s[t])s[t]=l.exports;else if(d!==e||!w)s[t]=d}else t&&(s[t]=u)},requirejs=require=n=function(s,o,a,f,l){return typeof s=="string"?i[s]?i[s](o):m(r(s,o).f):(s.splice||(u=s,o.splice?(s=o,o=a,a=null):s=e),o=o||function(){},typeof a=="function"&&(a=f,f=l),f?t(e,s,o,a):setTimeout(function(){t(e,s,o,a)},4),n)},n.config=function(e){return u=e,u.deps&&n(u.deps,u.callback),n},define=function(e,t,n){t.splice||(n=t,t=[]),!c(s,e)&&!c(o,e)&&(o[e]=[e,t,n])},define.amd={jQuery:!0}})(),define("rq/almond",function(){}),define("util/Class",[],function(){var e=!1,t=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/,n=function(){};return n.extend=function(n){function o(){!e&&this.init&&this.init.apply(this,arguments)}var r=this.prototype;e=!0;var i=new this;e=!1;for(var s in n)i[s]=typeof n[s]=="function"&&typeof r[s]=="function"&&t.test(n[s])?function(e,t){return function(){var n=this._super;this._super=r[e];var i=t.apply(this,arguments);return this._super=n,i}}(s,n[s]):n[s];return o.prototype=i,o.prototype.constructor=o,o.extend=arguments.callee,o},n}),define("config",[],function(){var e={env:"prod",connection:{},emptyOfferPop:"SiteMerchandising_EmptyCart",defaultCurrency:"USD",defaultLocale:"en_US",vanityDomain:"store.digitalriver.com"};return e.connection.URI={BASE_URL:null,DEV_BASE_URL:"http://23.21.197.49",SYS_BASE_URL:"http://23.21.197.49:2080",PRD_BASE_URL:"https://api.digitalriver.com",CTE_BASE_URL:"https://api-cte.digitalriver.com",VERSION:"v1",ANONYMOUS_LOGIN:"shoppers/token",CATEGORY_RESOURCE:"shoppers/me/categories",CART_RESOURCE:"shoppers/me/carts/active",OFFER_RESOURCE:"shoppers/me/point-of-promotions",WEB_CHECKOUT:"shoppers/me/carts/active/web-checkout",SHOPPER:"shoppers/me",HOME_PAGE_OFFER:"shoppers/me/point-of-promotions",LINE_ITEM_RESOURCE:"shoppers/me/carts/active/line-items",PRODUCT_RESOURCE:"shoppers/me/products"},{getBaseUrl:function(){var t=this,n=e.connection.URI,r;switch(t.getEnv()){case"dev":r=n.DEV_BASE_URL;break;case"sys":r=n.SYS_BASE_URL;break;case"cte":r=n.CTE_BASE_URL;break;case"prod":default:r=n.PRD_BASE_URL}return r},getHomePageOfferUrl:function(){var t=this,n=e.connection.URI;return[t.getBaseUrl(),n.VERSION,n.OFFER_RESOURCE,e.homePagePop,"offers",e.homePageOfferId,"product-offers"].join("/")},getAnonymousLoginUri:function(){var t=this,n=e.connection.URI;return[t.getBaseUrl(),n.VERSION,n.ANONYMOUS_LOGIN].join("/")},getTokenServiceUri:function(e,t){var n=this,r=e||n.getDefaultLocale(),i=["Action=ShopDomain","Locale="+r,"SiteId="+t].join("&");return"https://"+n.getVanityDomain()+"/store?"+i},getCategoryResourceUrl:function(){var t=this,n=e.connection.URI;return[t.getBaseUrl(),n.VERSION,n.CATEGORY_RESOURCE].join("/")},getCartResourceUrl:function(){var t=this,n=e.connection.URI;return[t.getBaseUrl(),n.VERSION,n.CART_RESOURCE].join("/")},getWebCheckoutUrl:function(){var t=this,n=e.connection.URI;return[t.getBaseUrl(),n.VERSION,n.WEB_CHECKOUT].join("/")},getEmptyOfferUrl:function(){var t=this,n=e.connection.URI;if(e.emptyOfferPop!=null&&e.emptyOfferId!=null)return[t.getBaseUrl(),n.VERSION,n.OFFER_RESOURCE,e.emptyOfferPop,"offers",e.emptyOfferId].join("/")},getLineItemUrl:function(){var t=this,n=e.connection.URI;return[t.getBaseUrl(),n.VERSION,n.LINE_ITEM_RESOURCE].join("/")},getProductResourceURL:function(){var t=this,n=e.connection.URI;return[t.getBaseUrl(),n.VERSION,n.PRODUCT_RESOURCE].join("/")},getShopperUrl:function(){var t=this,n=e.connection.URI;return[t.getBaseUrl(),n.VERSION,n.SHOPPER].join("/")},getEnv:function(){return e.env},setEnv:function(t){e.env=t},getApiKey:function(){return e.apiKey},setApiKey:function(t){e.apiKey=t},getDefaultCurrency:function(){return e.defaultCurrency},setDefaultCurrency:function(t){e.defaultCurrency=t},getDefaultLocale:function(){return e.defaultLocale},setDefaultLocale:function(t){e.defaultLocale=t},getEmptyOfferId:function(){return e.emptyOfferId},setEmptyOfferId:function(t){e.emptyOfferId=t},getEmptyOfferPop:function(){return e.emptyOfferPop},setEmptyOfferPop:function(t){e.emptyOfferPop=t},getSiteId:function(){return e.siteId},setSiteId:function(t){e.siteId=t},getVanityDomain:function(){return e.vanityDomain},setVanityDomain:function(t){e.vanityDomain=t}}}),function(e){if(typeof bootstrap=="function")bootstrap("promise",e);else if(typeof exports=="object")module.exports=e();else if(typeof define=="function"&&define.amd)define("lib/q",e);else if(typeof ses!="undefined"){if(!ses.ok())return;ses.makeQ=e}else Q=e()}(function(){function i(e){var t=Function.call;return function(){return t.apply(e,arguments)}}function p(e){return h(e)==="[object StopIteration]"||e instanceof d}function m(e,t){t.stack&&typeof e=="object"&&e!==null&&e.stack&&e.stack.indexOf(v)===-1&&(e.stack=g(e.stack)+"\n"+v+"\n"+g(t.stack))}function g(e){var t=e.split("\n"),n=[];for(var r=0;r<t.length;++r){var i=t[r];!b(i)&&!y(i)&&n.push(i)}return n.join("\n")}function y(e){return e.indexOf("(module.js:")!==-1||e.indexOf("(node.js:")!==-1}function b(n){var r=/at .+ \((.*):(\d+):\d+\)/.exec(n);if(!r)return!1;var i=r[1],s=r[2];return i===t&&s>=e&&s<=pt}function w(){if(Error.captureStackTrace){var e,n,r=Error.prepareStackTrace;return Error.prepareStackTrace=function(t,r){e=r[1].getFileName(),n=r[1].getLineNumber()},(new Error).stack,Error.prepareStackTrace=r,t=e,n}}function E(e){return j(e)}function S(){function a(i){if(!e)return;n=j(i),o(e,function(e,t){r(function(){n.promiseDispatch.apply(n,t)})},void 0),e=void 0,t=void 0}var e=[],t=[],n,i=f(S.prototype),u=f(T.prototype);return u.promiseDispatch=function(i,o,u){var a=s(arguments);e?(e.push(a),o==="when"&&u[1]&&t.push(u[1])):r(function(){n.promiseDispatch.apply(n,a)})},u.valueOf=function(){if(e)return u;var t=N(n);return C(t)&&(n=t),t},Error.captureStackTrace&&E.longStackJumpLimit>0&&(Error.captureStackTrace(u,S),u.stack=u.stack.substring(u.stack.indexOf("\n")+1)),i.promise=u,i.resolve=a,i.fulfill=function(e){a(B(e))},i.reject=function(e){a(H(e))},i.notify=function(n){e&&o(t,function(e,t){r(function(){t(n)})},void 0)},i}function x(e){var t=S();return Q(e,t.resolve,t.reject,t.notify).fail(t.reject),t.promise}function T(e,t,n,r,i){t===void 0&&(t=function(e){return H(new Error("Promise does not support operation: "+e))});var s=f(T.prototype);return s.promiseDispatch=function(n,r,i){var o;try{e[r]?o=e[r].apply(s,i):o=t.call(s,r,i)}catch(u){o=H(u)}n&&n(o)},n&&(s.valueOf=n),i&&(s.exception=r),s}function N(e){return C(e)?e.valueOf():e}function C(e){return e&&typeof e.promiseDispatch=="function"}function k(e){return e&&typeof e.then=="function"}function L(e){return!A(e)&&!O(e)}function A(e){return!k(N(e))}function O(e){return e=N(e),C(e)&&"exception"in e}function P(){!D&&typeof window!="undefined"&&!window.Touch&&window.console&&console.log("Should be empty:",_),D=!0}function H(e){var t=T({when:function(t){if(t){var n=u(M,this);n!==-1&&(_.splice(n,1),M.splice(n,1))}return t?t(e):this}},function(){return H(e)},function n(){return this},e,!0);return P(),M.push(t),_.push(e),t}function B(e){return T({when:function(){return e},get:function(t){return e[t]},set:function(t,n){e[t]=n},"delete":function(t){delete e[t]},post:function(t,n){return t===null||t===void 0?e.apply(void 0,n):e[t].apply(e,n)},apply:function(t,n){return e.apply(t,n)},keys:function(){return c(e)}},void 0,function t(){return e})}function j(e){return C(e)?e:(e=N(e),k(e)?F(e):B(e))}function F(e){var t=S();return r(function(){try{e.then(t.resolve,t.reject,t.notify)}catch(n){t.reject(n)}}),t.promise}function I(e){return T({isDef:function(){}},function(n,r){return X(e,n,r)},function(){return N(e)})}function q(e,t,n,i){function u(e){try{return typeof t=="function"?t(e):e}catch(n){return H(n)}}function a(e){if(typeof n=="function"){m(e,l);try{return n(e)}catch(t){return H(t)}}return H(e)}function f(e){return typeof i=="function"?i(e):e}var s=S(),o=!1,l=j(e);return r(function(){l.promiseDispatch(function(e){if(o)return;o=!0,s.resolve(u(e))},"when",[function(e){if(o)return;o=!0,s.resolve(a(e))}])}),l.promiseDispatch(void 0,"when",[void 0,function(e){var t,n=!1;try{t=f(e)}catch(r){n=!0;if(!E.onerror)throw r;E.onerror(r)}n||s.notify(t)}]),s.promise}function R(e,t,n){return q(e,function(e){return Y(e).then(function(e){return t.apply(void 0,e)},n)},n)}function U(e){return function(){function t(e,t){var s;try{s=n[e](t)}catch(o){return p(o)?o.value:H(o)}return q(s,r,i)}var n=e.apply(this,arguments),r=t.bind(t,"send"),i=t.bind(t,"throw");return r()}}function z(e){throw new d(e)}function W(e){return function(){return R([this,Y(arguments)],function(t,n){return e.apply(t,n)})}}function X(e,t,n){var i=S();return r(function(){j(e).promiseDispatch(i.resolve,t,n)}),i.promise}function V(e){return function(t){var n=s(arguments,1);return X(t,e,n)}}function J(e,t){var n=s(arguments,2);return $(e,t,n)}function K(e,t){return X(e,"apply",[void 0,t])}function Q(e){var t=s(arguments,1);return K(e,t)}function G(e){var t=s(arguments,1);return function(){var r=t.concat(s(arguments));return X(e,"apply",[this,r])}}function Y(e){return q(e,function(e){var t=0,n=S();return o(e,function(r,i,s){A(i)?e[s]=N(i):(++t,q(i,function(r){e[s]=r,--t===0&&n.resolve(e)},n.reject))},void 0),t===0&&n.resolve(e),n.promise})}function Z(e){return q(e,function(e){return e=a(e,j),q(Y(a(e,function(e){return q(e,n,n)})),function(){return e})})}function et(e,t){return q(e,void 0,t)}function tt(e,t){return q(e,void 0,void 0,t)}function nt(e,t){return q(e,function(e){return q(t(),function(){return e})},function(e){return q(t(),function(){return H(e)})})}function rt(e,t,n,i){var s=function(t){r(function(){m(t,e);if(!E.onerror)throw t;E.onerror(t)})},o=t||n||i?q(e,t,n,i):e;typeof process=="object"&&process&&process.domain&&(s=process.domain.bind(s)),et(o,s)}function it(e,t){var n=S(),r=setTimeout(function(){n.reject(new Error("Timed out after "+t+" ms"))},t);return q(e,function(e){clearTimeout(r),n.resolve(e)},function(e){clearTimeout(r),n.reject(e)},n.notify),n.promise}function st(e,t){t===void 0&&(t=e,e=void 0);var n=S();return q(e,undefined,undefined,n.notify),setTimeout(function(){n.resolve(e)},t),n.promise}function ot(e,t){var n=s(t),r=S();return n.push(r.makeNodeResolver()),K(e,n).fail(r.reject),r.promise}function ut(e){var t=s(arguments,1),n=S();return t.push(n.makeNodeResolver()),K(e,t).fail(n.reject),n.promise}function at(e){var t=s(arguments,1);return function(){var n=t.concat(s(arguments)),r=S();return n.push(r.makeNodeResolver()),K(e,n).fail(r.reject),r.promise}}function ft(e,t){var n=s(arguments,2);return function(){function o(){return e.apply(t,arguments)}var r=n.concat(s(arguments)),i=S();return r.push(i.makeNodeResolver()),K(o,r).fail(i.reject),i.promise}}function lt(e,t,n){var r=s(n||[]),i=S();return r.push(i.makeNodeResolver()),$(e,t,r).fail(i.reject),i.promise}function ct(e,t){var n=s(arguments,2),r=S();return n.push(r.makeNodeResolver()),$(e,t,n).fail(r.reject),r.promise}function ht(e,t){if(!t)return e;e.then(function(e){r(function(){t(null,e)})},function(e){r(function(){t(e)})})}var e=w(),t,n=function(){},r;typeof process!="undefined"?r=process.nextTick:typeof setImmediate=="function"?typeof window!="undefined"?r=setImmediate.bind(window):r=setImmediate:function(){function a(){--i;if(++o>=n){o=0,n*=4;var t=s&&Math.min(s-1,n);while(i<t)++i,u()}while(s){--s,e=e.next;var r=e.task;e.task=void 0,r()}o=0}var e={task:void 0,next:null},t=e,n=2,i=0,s=0,o=0,u;r=function(e){t=t.next={task:e,next:null},i<++s&&i<n&&(++i,u())};if(typeof MessageChannel!="undefined"){var f=new MessageChannel;f.port1.onmessage=a,u=function(){f.port2.postMessage(0)}}else u=function(){setTimeout(a,0)}}();var s=i(Array.prototype.slice),o=i(Array.prototype.reduce||function(e,t){var n=0,r=this.length;if(arguments.length===1)do{if(n in this){t=this[n++];break}if(++n>=r)throw new TypeError}while(1);for(;n<r;n++)n in this&&(t=e(t,this[n],n));return t}),u=i(Array.prototype.indexOf||function(e){for(var t=0;t<this.length;t++)if(this[t]===e)return t;return-1}),a=i(Array.prototype.map||function(e,t){var n=this,r=[];return o(n,function(i,s,o){r.push(e.call(t,s,o,n))},void 0),r}),f=Object.create||function(e){function t(){}return t.prototype=e,new t},l=i(Object.prototype.hasOwnProperty),c=Object.keys||function(e){var t=[];for(var n in e)l(e,n)&&t.push(n);return t},h=i(Object.prototype.toString),d;typeof ReturnValue!="undefined"?d=ReturnValue:d=function(e){this.value=e},E.longStackJumpLimit=1;var v="From previous event:";E.nextTick=r,E.defer=S,S.prototype.makeNodeResolver=function(){var e=this;return function(t,n){t?e.reject(t):arguments.length>2?e.resolve(s(arguments,1)):e.resolve(n)}},E.promise=x,E.makePromise=T,T.prototype.then=function(e,t,n){return q(this,e,t,n)},T.prototype.thenResolve=function(e){return q(this,function(){return e})},T.prototype.thenReject=function(e){return q(this,function(){throw e})},o(["isFulfilled","isRejected","isPending","dispatch","when","spread","get","put","set","del","delete","post","send","invoke","keys","fapply","fcall","fbind","all","allResolved","timeout","delay","catch","finally","fail","fin","progress","done","nfcall","nfapply","nfbind","denodeify","nbind","ncall","napply","nbind","npost","nsend","ninvoke","nodeify"],function(e,t){T.prototype[t]=function(){return E[t].apply(E,[this].concat(s(arguments)))}},void 0),T.prototype.toSource=function(){return this.toString()},T.prototype.toString=function(){return"[object Promise]"},E.nearer=N,E.isPromise=C,E.isPromiseAlike=k,E.isPending=L,E.isFulfilled=A,E.isRejected=O;var M=[],_=[],D;typeof process!="undefined"&&process.on&&process.on("exit",function(){for(var e=0;e<_.length;e++){var t=_[e];t&&typeof t.stack!="undefined"?console.warn("Unhandled rejected promise:",t.stack):console.warn("Unhandled rejected promise (no stack):",t)}}),E.reject=H,E.fulfill=B,E.resolve=j,E.master=I,E.when=q,E.spread=R,E.async=U,E["return"]=z,E.promised=W,E.dispatch=X,E.dispatcher=V,E.get=V("get"),E.set=V("set"),E["delete"]=E.del=V("delete");var $=E.post=V("post");E.send=J,E.invoke=J,E.fapply=K,E["try"]=Q,E.fcall=Q,E.fbind=G,E.keys=V("keys"),E.all=Y,E.allResolved=Z,E["catch"]=E.fail=et,E.progress=tt,E["finally"]=E.fin=nt,E.done=rt,E.timeout=it,E.delay=st,E.nfapply=ot,E.nfcall=ut,E.nfbind=at,E.denodeify=E.nfbind,E.nbind=ft,E.npost=lt,E.nsend=ct,E.ninvoke=E.nsend,E.nodeify=ht;var pt=w();return E}),function(){var e=this,t=e._,n={},r=Array.prototype,i=Object.prototype,s=Function.prototype,o=r.push,u=r.slice,a=r.concat,f=i.toString,l=i.hasOwnProperty,c=r.forEach,h=r.map,p=r.reduce,d=r.reduceRight,v=r.filter,m=r.every,g=r.some,y=r.indexOf,b=r.lastIndexOf,w=Array.isArray,E=Object.keys,S=s.bind,x=function(e){return e instanceof x?e:this instanceof x?(this._wrapped=e,void 0):new x(e)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=x),exports._=x):e._=x,x.VERSION="1.4.4";var T=x.each=x.forEach=function(e,t,r){if(null!=e)if(c&&e.forEach===c)e.forEach(t,r);else if(e.length===+e.length){for(var i=0,s=e.length;s>i;i++)if(t.call(r,e[i],i,e)===n)return}else for(var o in e)if(x.has(e,o)&&t.call(r,e[o],o,e)===n)return};x.map=x.collect=function(e,t,n){var r=[];return null==e?r:h&&e.map===h?e.map(t,n):(T(e,function(e,i,s){r[r.length]=t.call(n,e,i,s)}),r)};var N="Reduce of empty array with no initial value";x.reduce=x.foldl=x.inject=function(e,t,n,r){var i=arguments.length>2;if(null==e&&(e=[]),p&&e.reduce===p)return r&&(t=x.bind(t,r)),i?e.reduce(t,n):e.reduce(t);if(T(e,function(e,s,o){i?n=t.call(r,n,e,s,o):(n=e,i=!0)}),!i)throw new TypeError(N);return n},x.reduceRight=x.foldr=function(e,t,n,r){var i=arguments.length>2;if(null==e&&(e=[]),d&&e.reduceRight===d)return r&&(t=x.bind(t,r)),i?e.reduceRight(t,n):e.reduceRight(t);var s=e.length;if(s!==+s){var o=x.keys(e);s=o.length}if(T(e,function(u,a,f){a=o?o[--s]:--s,i?n=t.call(r,n,e[a],a,f):(n=e[a],i=!0)}),!i)throw new TypeError(N);return n},x.find=x.detect=function(e,t,n){var r;return C(e,function(e,i,s){return t.call(n,e,i,s)?(r=e,!0):void 0}),r},x.filter=x.select=function(e,t,n){var r=[];return null==e?r:v&&e.filter===v?e.filter(t,n):(T(e,function(e,i,s){t.call(n,e,i,s)&&(r[r.length]=e)}),r)},x.reject=function(e,t,n){return x.filter(e,function(e,r,i){return!t.call(n,e,r,i)},n)},x.every=x.all=function(e,t,r){t||(t=x.identity);var i=!0;return null==e?i:m&&e.every===m?e.every(t,r):(T(e,function(e,s,o){return(i=i&&t.call(r,e,s,o))?void 0:n}),!!i)};var C=x.some=x.any=function(e,t,r){t||(t=x.identity);var i=!1;return null==e?i:g&&e.some===g?e.some(t,r):(T(e,function(e,s,o){return i||(i=t.call(r,e,s,o))?n:void 0}),!!i)};x.contains=x.include=function(e,t){return null==e?!1:y&&e.indexOf===y?e.indexOf(t)!=-1:C(e,function(e){return e===t})},x.invoke=function(e,t){var n=u.call(arguments,2),r=x.isFunction(t);return x.map(e,function(e){return(r?t:e[t]).apply(e,n)})},x.pluck=function(e,t){return x.map(e,function(e){return e[t]})},x.where=function(e,t,n){return x.isEmpty(t)?n?null:[]:x[n?"find":"filter"](e,function(e){for(var n in t)if(t[n]!==e[n])return!1;return!0})},x.findWhere=function(e,t){return x.where(e,t,!0)},x.max=function(e,t,n){if(!t&&x.isArray(e)&&e[0]===+e[0]&&65535>e.length)return Math.max.apply(Math,e);if(!t&&x.isEmpty(e))return-1/0;var r={computed:-1/0,value:-1/0};return T(e,function(e,i,s){var o=t?t.call(n,e,i,s):e;o>=r.computed&&(r={value:e,computed:o})}),r.value},x.min=function(e,t,n){if(!t&&x.isArray(e)&&e[0]===+e[0]&&65535>e.length)return Math.min.apply(Math,e);if(!t&&x.isEmpty(e))return 1/0;var r={computed:1/0,value:1/0};return T(e,function(e,i,s){var o=t?t.call(n,e,i,s):e;r.computed>o&&(r={value:e,computed:o})}),r.value},x.shuffle=function(e){var t,n=0,r=[];return T(e,function(e){t=x.random(n++),r[n-1]=r[t],r[t]=e}),r};var k=function(e){return x.isFunction(e)?e:function(t){return t[e]}};x.sortBy=function(e,t,n){var r=k(t);return x.pluck(x.map(e,function(e,t,i){return{value:e,index:t,criteria:r.call(n,e,t,i)}}).sort(function(e,t){var n=e.criteria,r=t.criteria;if(n!==r){if(n>r||n===void 0)return 1;if(r>n||r===void 0)return-1}return e.index<t.index?-1:1}),"value")};var L=function(e,t,n,r){var i={},s=k(t||x.identity);return T(e,function(t,o){var u=s.call(n,t,o,e);r(i,u,t)}),i};x.groupBy=function(e,t,n){return L(e,t,n,function(e,t,n){(x.has(e,t)?e[t]:e[t]=[]).push(n)})},x.countBy=function(e,t,n){return L(e,t,n,function(e,t){x.has(e,t)||(e[t]=0),e[t]++})},x.sortedIndex=function(e,t,n,r){n=null==n?x.identity:k(n);for(var i=n.call(r,t),s=0,o=e.length;o>s;){var u=s+o>>>1;i>n.call(r,e[u])?s=u+1:o=u}return s},x.toArray=function(e){return e?x.isArray(e)?u.call(e):e.length===+e.length?x.map(e,x.identity):x.values(e):[]},x.size=function(e){return null==e?0:e.length===+e.length?e.length:x.keys(e).length},x.first=x.head=x.take=function(e,t,n){return null==e?void 0:null==t||n?e[0]:u.call(e,0,t)},x.initial=function(e,t,n){return u.call(e,0,e.length-(null==t||n?1:t))},x.last=function(e,t,n){return null==e?void 0:null==t||n?e[e.length-1]:u.call(e,Math.max(e.length-t,0))},x.rest=x.tail=x.drop=function(e,t,n){return u.call(e,null==t||n?1:t)},x.compact=function(e){return x.filter(e,x.identity)};var A=function(e,t,n){return T(e,function(e){x.isArray(e)?t?o.apply(n,e):A(e,t,n):n.push(e)}),n};x.flatten=function(e,t){return A(e,t,[])},x.without=function(e){return x.difference(e,u.call(arguments,1))},x.uniq=x.unique=function(e,t,n,r){x.isFunction(t)&&(r=n,n=t,t=!1);var i=n?x.map(e,n,r):e,s=[],o=[];return T(i,function(n,r){(t?r&&o[o.length-1]===n:x.contains(o,n))||(o.push(n),s.push(e[r]))}),s},x.union=function(){return x.uniq(a.apply(r,arguments))},x.intersection=function(e){var t=u.call(arguments,1);return x.filter(x.uniq(e),function(e){return x.every(t,function(t){return x.indexOf(t,e)>=0})})},x.difference=function(e){var t=a.apply(r,u.call(arguments,1));return x.filter(e,function(e){return!x.contains(t,e)})},x.zip=function(){for(var e=u.call(arguments),t=x.max(x.pluck(e,"length")),n=Array(t),r=0;t>r;r++)n[r]=x.pluck(e,""+r);return n},x.object=function(e,t){if(null==e)return{};for(var n={},r=0,i=e.length;i>r;r++)t?n[e[r]]=t[r]:n[e[r][0]]=e[r][1];return n},x.indexOf=function(e,t,n){if(null==e)return-1;var r=0,i=e.length;if(n){if("number"!=typeof n)return r=x.sortedIndex(e,t),e[r]===t?r:-1;r=0>n?Math.max(0,i+n):n}if(y&&e.indexOf===y)return e.indexOf(t,n);for(;i>r;r++)if(e[r]===t)return r;return-1},x.lastIndexOf=function(e,t,n){if(null==e)return-1;var r=null!=n;if(b&&e.lastIndexOf===b)return r?e.lastIndexOf(t,n):e.lastIndexOf(t);for(var i=r?n:e.length;i--;)if(e[i]===t)return i;return-1},x.range=function(e,t,n){1>=arguments.length&&(t=e||0,e=0),n=arguments[2]||1;for(var r=Math.max(Math.ceil((t-e)/n),0),i=0,s=Array(r);r>i;)s[i++]=e,e+=n;return s},x.bind=function(e,t){if(e.bind===S&&S)return S.apply(e,u.call(arguments,1));var n=u.call(arguments,2);return function(){return e.apply(t,n.concat(u.call(arguments)))}},x.partial=function(e){var t=u.call(arguments,1);return function(){return e.apply(this,t.concat(u.call(arguments)))}},x.bindAll=function(e){var t=u.call(arguments,1);return 0===t.length&&(t=x.functions(e)),T(t,function(t){e[t]=x.bind(e[t],e)}),e},x.memoize=function(e,t){var n={};return t||(t=x.identity),function(){var r=t.apply(this,arguments);return x.has(n,r)?n[r]:n[r]=e.apply(this,arguments)}},x.delay=function(e,t){var n=u.call(arguments,2);return setTimeout(function(){return e.apply(null,n)},t)},x.defer=function(e){return x.delay.apply(x,[e,1].concat(u.call(arguments,1)))},x.throttle=function(e,t){var n,r,i,s,o=0,u=function(){o=new Date,i=null,s=e.apply(n,r)};return function(){var a=new Date,f=t-(a-o);return n=this,r=arguments,0>=f?(clearTimeout(i),i=null,o=a,s=e.apply(n,r)):i||(i=setTimeout(u,f)),s}},x.debounce=function(e,t,n){var r,i;return function(){var s=this,o=arguments,u=function(){r=null,n||(i=e.apply(s,o))},a=n&&!r;return clearTimeout(r),r=setTimeout(u,t),a&&(i=e.apply(s,o)),i}},x.once=function(e){var t,n=!1;return function(){return n?t:(n=!0,t=e.apply(this,arguments),e=null,t)}},x.wrap=function(e,t){return function(){var n=[e];return o.apply(n,arguments),t.apply(this,n)}},x.compose=function(){var e=arguments;return function(){for(var t=arguments,n=e.length-1;n>=0;n--)t=[e[n].apply(this,t)];return t[0]}},x.after=function(e,t){return 0>=e?t():function(){return 1>--e?t.apply(this,arguments):void 0}},x.keys=E||function(e){if(e!==Object(e))throw new TypeError("Invalid object");var t=[];for(var n in e)x.has(e,n)&&(t[t.length]=n);return t},x.values=function(e){var t=[];for(var n in e)x.has(e,n)&&t.push(e[n]);return t},x.pairs=function(e){var t=[];for(var n in e)x.has(e,n)&&t.push([n,e[n]]);return t},x.invert=function(e){var t={};for(var n in e)x.has(e,n)&&(t[e[n]]=n);return t},x.functions=x.methods=function(e){var t=[];for(var n in e)x.isFunction(e[n])&&t.push(n);return t.sort()},x.extend=function(e){return T(u.call(arguments,1),function(t){if(t)for(var n in t)e[n]=t[n]}),e},x.pick=function(e){var t={},n=a.apply(r,u.call(arguments,1));return T(n,function(n){n in e&&(t[n]=e[n])}),t},x.omit=function(e){var t={},n=a.apply(r,u.call(arguments,1));for(var i in e)x.contains(n,i)||(t[i]=e[i]);return t},x.defaults=function(e){return T(u.call(arguments,1),function(t){if(t)for(var n in t)null==e[n]&&(e[n]=t[n])}),e},x.clone=function(e){return x.isObject(e)?x.isArray(e)?e.slice():x.extend({},e):e},x.tap=function(e,t){return t(e),e};var O=function(e,t,n,r){if(e===t)return 0!==e||1/e==1/t;if(null==e||null==t)return e===t;e instanceof x&&(e=e._wrapped),t instanceof x&&(t=t._wrapped);var i=f.call(e);if(i!=f.call(t))return!1;switch(i){case"[object String]":return e==t+"";case"[object Number]":return e!=+e?t!=+t:0==e?1/e==1/t:e==+t;case"[object Date]":case"[object Boolean]":return+e==+t;case"[object RegExp]":return e.source==t.source&&e.global==t.global&&e.multiline==t.multiline&&e.ignoreCase==t.ignoreCase}if("object"!=typeof e||"object"!=typeof t)return!1;for(var s=n.length;s--;)if(n[s]==e)return r[s]==t;n.push(e),r.push(t);var o=0,u=!0;if("[object Array]"==i){if(o=e.length,u=o==t.length)for(;o--&&(u=O(e[o],t[o],n,r)););}else{var a=e.constructor,l=t.constructor;if(a!==l&&!(x.isFunction(a)&&a instanceof a&&x.isFunction(l)&&l instanceof l))return!1;for(var c in e)if(x.has(e,c)&&(o++,!(u=x.has(t,c)&&O(e[c],t[c],n,r))))break;if(u){for(c in t)if(x.has(t,c)&&!(o--))break;u=!o}}return n.pop(),r.pop(),u};x.isEqual=function(e,t){return O(e,t,[],[])},x.isEmpty=function(e){if(null==e)return!0;if(x.isArray(e)||x.isString(e))return 0===e.length;for(var t in e)if(x.has(e,t))return!1;return!0},x.isElement=function(e){return!!e&&1===e.nodeType},x.isArray=w||function(e){return"[object Array]"==f.call(e)},x.isObject=function(e){return e===Object(e)},T(["Arguments","Function","String","Number","Date","RegExp"],function(e){x["is"+e]=function(t){return f.call(t)=="[object "+e+"]"}}),x.isArguments(arguments)||(x.isArguments=function(e){return!!e&&!!x.has(e,"callee")}),"function"!=typeof /./&&(x.isFunction=function(e){return"function"==typeof e}),x.isFinite=function(e){return isFinite(e)&&!isNaN(parseFloat(e))},x.isNaN=function(e){return x.isNumber(e)&&e!=+e},x.isBoolean=function(e){return e===!0||e===!1||"[object Boolean]"==f.call(e)},x.isNull=function(e){return null===e},x.isUndefined=function(e){return e===void 0},x.has=function(e,t){return l.call(e,t)},x.noConflict=function(){return e._=t,this},x.identity=function(e){return e},x.times=function(e,t,n){for(var r=Array(e),i=0;e>i;i++)r[i]=t.call(n,i);return r},x.random=function(e,t){return null==t&&(t=e,e=0),e+Math.floor(Math.random()*(t-e+1))};var M={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"}};M.unescape=x.invert(M.escape);var _={escape:RegExp("["+x.keys(M.escape).join("")+"]","g"),unescape:RegExp("("+x.keys(M.unescape).join("|")+")","g")};x.each(["escape","unescape"],function(e){x[e]=function(t){return null==t?"":(""+t).replace(_[e],function(t){return M[e][t]})}}),x.result=function(e,t){if(null==e)return null;var n=e[t];return x.isFunction(n)?n.call(e):n},x.mixin=function(e){T(x.functions(e),function(t){var n=x[t]=e[t];x.prototype[t]=function(){var e=[this._wrapped];return o.apply(e,arguments),j.call(this,n.apply(x,e))}})};var D=0;x.uniqueId=function(e){var t=++D+"";return e?e+t:t},x.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var P=/(.)^/,H={"'":"'","\\":"\\","\r":"r","\n":"n","    ":"t","\u2028":"u2028","\u2029":"u2029"},B=/\\|'|\r|\n|\t|\u2028|\u2029/g;x.template=function(e,t,n){var r;n=x.defaults({},n,x.templateSettings);var i=RegExp([(n.escape||P).source,(n.interpolate||P).source,(n.evaluate||P).source].join("|")+"|$","g"),s=0,o="__p+='";e.replace(i,function(t,n,r,i,u){return o+=e.slice(s,u).replace(B,function(e){return"\\"+H[e]}),n&&(o+="'+\n((__t=("+n+"))==null?'':_.escape(__t))+\n'"),r&&(o+="'+\n((__t=("+r+"))==null?'':__t)+\n'"),i&&(o+="';\n"+i+"\n__p+='"),s=u+t.length,t}),o+="';\n",n.variable||(o="with(obj||{}){\n"+o+"}\n"),o="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+o+"return __p;\n";try{r=Function(n.variable||"obj","_",o)}catch(u){throw u.source=o,u}if(t)return r(t,x);var a=function(e){return r.call(this,e,x)};return a.source="function("+(n.variable||"obj")+"){\n"+o+"}",a},x.chain=function(e){return x(e).chain()};var j=function(e){return this._chain?x(e).chain():e};x.mixin(x),T(["pop","push","reverse","shift","sort","splice","unshift"],function(e){var t=r[e];x.prototype[e]=function(){var n=this._wrapped;return t.apply(n,arguments),"shift"!=e&&"splice"!=e||0!==n.length||delete n[0],j.call(this,n)}}),T(["concat","join","slice"],function(e){var t=r[e];x.prototype[e]=function(){return j.call(this,t.apply(this._wrapped,arguments))}}),x.extend(x.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}})}.call(this),define("lib/underscore",function(e){return function(){var t,n;return t||e._}}(this)),typeof JSON!="object"&&(JSON={}),function(){function f(e){return e<10?"0"+e:e}function quote(e){return escapable.lastIndex=0,escapable.test(e)?'"'+e.replace(escapable,function(e){var t=meta[e];return typeof t=="string"?t:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+e+'"'}function str(e,t){var n,r,i,s,o=gap,u,a=t[e];a&&typeof a=="object"&&typeof a.toJSON=="function"&&(a=a.toJSON(e)),typeof rep=="function"&&(a=rep.call(t,e,a));switch(typeof a){case"string":return quote(a);case"number":return isFinite(a)?String(a):"null";case"boolean":case"null":return String(a);case"object":if(!a)return"null";gap+=indent,u=[];if(Object.prototype.toString.apply(a)==="[object Array]"){s=a.length;for(n=0;n<s;n+=1)u[n]=str(n,a)||"null";return i=u.length===0?"[]":gap?"[\n"+gap+u.join(",\n"+gap)+"\n"+o+"]":"["+u.join(",")+"]",gap=o,i}if(rep&&typeof rep=="object"){s=rep.length;for(n=0;n<s;n+=1)typeof rep[n]=="string"&&(r=rep[n],i=str(r,a),i&&u.push(quote(r)+(gap?": ":":")+i))}else for(r in a)Object.prototype.hasOwnProperty.call(a,r)&&(i=str(r,a),i&&u.push(quote(r)+(gap?": ":":")+i));return i=u.length===0?"{}":gap?"{\n"+gap+u.join(",\n"+gap)+"\n"+o+"}":"{"+u.join(",")+"}",gap=o,i}}typeof Date.prototype.toJSON!="function"&&(Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()});var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;typeof JSON.stringify!="function"&&(JSON.stringify=function(e,t,n){var r;gap="",indent="";if(typeof n=="number")for(r=0;r<n;r+=1)indent+=" ";else typeof n=="string"&&(indent=n);rep=t;if(!t||typeof t=="function"||typeof t=="object"&&typeof t.length=="number")return str("",{"":e});throw new Error("JSON.stringify")}),typeof JSON.parse!="function"&&(JSON.parse=function(text,reviver){function walk(e,t){var n,r,i=e[t];if(i&&typeof i=="object")for(n in i)Object.prototype.hasOwnProperty.call(i,n)&&(r=walk(i,n),r!==undefined?i[n]=r:delete i[n]);return reviver.call(e,t,i)}var j;text=String(text),cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(e){return"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)}));if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),typeof reviver=="function"?walk({"":j},""):j;throw new SyntaxError("JSON.parse")})}(),define("lib/json2",function(){}),define("util/jsonp",["lib/q","lib/underscore","lib/json2"],function(e,t,n){var r,i=function(e,t,n){this.name=e,this.message=t,this.value=n,this.toString=function(){return this.name+": "+this.message+" "+n.join(",")}};return r={callbackCounter:0,getJSON:function(n,r,s){var o=e.defer(),u=this,a,f=[],l,c;return f=t.map(s,function(e,t){return encodeURIComponent(t)+"="+encodeURIComponent(e)}),a="JSONPCallback_"+u.callbackCounter,u.callbackCounter+=1,window[a]=u.evalJSONP(o),f.push("callback="+a),f.push("format=json"),f.push("dt="+(new Date).getTime()),r&&(r=r.toLowerCase()),f.push("method="+r||"get"),n+=n.indexOf("?")===-1?"?"+f.join("&"):"&"+f.join("&"),l=document.createElement("SCRIPT"),l.src=n,c=document.getElementsByTagName("HEAD")[0].appendChild(l),c.onload=c.onreadystatechange=function(){if(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")setTimeout(function(){o.promise.isPending()&&window[a]&&window[a]({success:!0})},10),c.onload=c.onreadystatechange=null},c.onerror=function(){setTimeout(function(){o.promise.isPending()&&window[a]&&o.reject(new i("Server Error","",f))},10)},o.promise.then(function(e){window[a]=undefined;try{delete window[a]}catch(t){}try{c.parentNode.removeChild(c)}catch(t){}return e},function(e){window[a]=undefined;try{delete window[a]}catch(t){}try{c.parentNode.removeChild(c)}catch(t){}throw e})},evalJSONP:function(e){return function(t){var r=!1;if(typeof t=="string")try{r=n.parse(t)}catch(i){}else try{r=n.parse(n.stringify(t))}catch(s){r=t}r?e.resolve(r):e.reject("JSONP call returned invalid or empty JSON")}}},r}),define("connection/Connection",["util/jsonp"],function(e){var t=function(){};return t.prototype={create:function(e,t,n,r){return this.request(e,"POST",t,n,r)},retrieve:function(e,t,n,r){return this.request(e,"GET",t,n,r)},update:function(e,t,n){return this.request(e,"PUT",t,n)},remove:function(e,t,n){return this.request(e,"DELETE",t,n)},submitForm:function(e,t,n){return n=n||{},n["Content-Type"]="application/x-www-form-urlencoded",this.request(e,"POST",{},n,t)},request:function(t,n,r){return e.getJSON(t,n,r)}},t}),define("connection/Session",["config","connection/Connection","lib/q"],function(e,t,n){var r=function(e){var n=this;n.apiKey=e,n._connection=new t,n.reset()};return r.prototype={getAccess:function(e){if(!e||e!=="authenticated")return this.getLimitedAccess()},getLimitedAccess:function(){var e=this,t=e.getAccessToken(),r;return t?e.isTokenTimeStampValid()?r=n(t):r=e.anonymousLogin():r=e.anonymousLogin(),r},isTokenTimeStampValid:function(){var e=this,t=(new Date).getTime();return e.tokenExpirationTime&&e.tokenExpirationTime>t},doRefreshToken:function(e){return this.anonymousLogin(e)},anonymousLogin:function(t){var n=this,r=new Date,i=n.getLocale(),s=e.getSiteId(),o;return o=e.getTokenServiceUri(i,s),n.pendingRequest==null&&(n.pendingRequest=n._connection.request(o,"GET").then(function(e){var t={ts:r.getTime(),apiKey:n.apiKey};return e.stickyParameters===null||e.stickyParameters===""?t.domain=e.shopDomain:(t.domain=e.shopDomain,t.cookie=e.stickyParameters),n.getAnnonymousAccessToken(t)})),n.pendingRequest},getAnnonymousAccessToken:function(t,n){var r=this,i=e.getAnonymousLoginUri();return r._connection.request(i,"GET",t).then(function(e){return r.connected=!0,r.setAccessToken(e.access_token),r.setRefreshToken(e.refresh_token),r.tokenStartTime=(new Date).getTime(),r.tokenExpirationTime=(new Date).getTime()+parseInt(e.expires_in*1e3,10),n&&typeof n.resolve=="function"&&n.resolve(e.access_token),r.pendingRequest=null,e.access_token}).fail(function(e){n&&typeof n.reject=="function"&&n.reject(e),r.reset(),r.pendingRequest=null})},updateShopperSession:function(t){var n=this;t&&(n._locale=t.Locale||e.getDefaultLocale())},reset:function(){var e=this;e.setAccessToken(null),e.setRefreshToken(null),e.connected=!1,e.tokenStartTime=null,e.tokenExpirationTime=null},getAccessToken:function(){return this._token},setAccessToken:function(e){this._token=e},getRefreshToken:function(){return this._refreshToken},setRefreshToken:function(e){this._refreshToken=e},getClient:function(){return this._client},getLocale:function(){return this._locale||e.getDefaultLocale()}},r}),define("service/BaseService",["util/Class","connection/Connection"],function(e,t){var n=e.extend({init:function(e){var n=this;n._client=e,n._connection=new t},list:function(e,t,n){var r=this;return e=e||r.uri,r._client.connect().then(function(i){var s=r._makeQueryParams({token:i},t);return r._connection.request(e,"GET",s,n)})},get:function(e,t,n){var r=this,i=[r.uri,e].join("/");return r._client.connect().then(function(e){var s=r._makeQueryParams({token:e},t);return r._connection.request(i,"GET",s,n)})},post:function(e,t){var n=this;return e=e||n.uri,n._client.connect().then(function(r){var i=n._makeQueryParams({token:r},t);return n._connection.request(e,"POST",i)})},remove:function(e,t){var n=this;return e=e||n.uri,n._client.connect().then(function(r){var i=n._makeQueryParams({token:r},t);return n._connection.request(e,"DELETE",i)})},_makeQueryParams:function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e}});return n}),define("service/Shopper",["util/Class","service/BaseService","config"],function(e,t,n){var r={currency:null,locale:null};return t.extend({init:function(){var e=this;e._super.apply(this,arguments),e.uri=n.getShopperUrl()},list:function(){var e=this;return e._super.apply(e,[e.uri,{expand:"currency,locale"}])},updateShopper:function(e){var t=this,i=n.getShopperUrl();return e==null&&(e={}),e.currency=e.currency||n.getDefaultCurrency(),e.locale=e.locale||n.getDefaultLocale(),t.post(i,e).then(function(t){return t.success&&(r.currency=e.currency,r.locale=e.locale),r})}})}),define("api/Client",["util/Class","connection/Session","service/Shopper"],function(e,t,n){return e.extend({init:function(e){var r=this;r._session=new t(e),r.shopperService=new n(r)},connect:function(){var e=this,t=e._session;return $(e).trigger("drconnect-beforeconnect",[e]),t.getAccess()},disconnect:function(){this._session.reset()},getSession:function(){return this._session},updateShopper:function(e){var t=this;return this.shopperService.updateShopper(e).then(function(e){return t._session.updateShopperSession(e),e},function(){})}})}),define("util/util",[],function(){var e={};return e.namespace=function(e){var t=e.split("."),n=window,r="";for(var i=0,s=t.length;i<s;i++)r=t[i],n[r]=n[r]||{},n=n[r];return n},e.is_array=function(e){return typeof e=="object"&&e instanceof Array},e.is_string=function(e){return typeof e=="string"},e.getAttribute=function(e,t){var n=t.split("."),r=e,i="";for(var s=0,o=n.length;s<o;s++)i=n[s],r[i]=r[i]||{},r=r[i];return r},e.setAttribute=function(e,t,n){var r=t.split("."),i=e,s="";for(var o=0,u=r.length;o<u-1;o++)s=r[o],i[s]=i[s]||{},i=i[s];i[r[u-1]]=n},e.merge=function(e,t){for(var n in t)e[n]=t[n];return e},e.isAbsoluteUri=function(e){return e.lastIndexOf("http",0)===0},e.Error=function(e){this.message=e},e.getQueryStringParam=function(e,t){var n=(new RegExp("[\\?&]"+t+"=([^&#]*)")).exec(e);return n?n[1]||0:""},e.getCurrentPath=function(){var e=window.location.href.replace(window.location.hash,"");return e.substring(0,e.lastIndexOf("/"))},e}),define("service/CartService",["util/Class","service/BaseService","config","lib/q","util/util"],function(e,t,n,r,i){var s=null,o=t.extend({init:function(e){var t=this;t._super.apply(t,arguments),t.uri=n.getCartResourceUrl()},getActiveCart:function(){var e=this;return this.list(n.getCartResourceUrl(),{expand:"pricing.all,lineitems.lineitem.product,lineitems.lineitem.pricing.all,shippingOptions,shippingMethods"}).then(function(e){return e.cart})},getEmptyCartOffer:function(){var e=this;return s===null&&n.getEmptyOfferUrl()!=null?defer=this.list(n.getEmptyOfferUrl(),{expand:"productOffers.productOffer.addProductToCart"}).then(function(e){return s=e.offer,s},function(){defer=null}):defer=r(s),defer},applyCouponCode:function(e){var t=this;if($(t).triggerHandler("drconnect-beforeapplycode",[e])!==!1)return t.post(null,{promoCode:e}).then(function(e){return t.getActiveCart()},function(){return t.getActiveCart()})},addLineItemToCart:function(e){var t=this,r=i.getQueryStringParam(e,"productId"),s=[n.getProductResourceURL(),r].join("/");if($(t).triggerHandler("drconnect-beforeaddproduct",[e])!==!1)return t.list(s).then(function(n){if(n.product&&n.product.variations&&n.product.variations.product)throw $(t).trigger("drconnect-carterror",["Base  products can't be purchased."]),"Cannot add product to cart.";return t.post(e).then(function(e){return t.getActiveCart()},function(e){throw $(t).trigger("drconnect-carterror",[e]),e})},function(e){throw $(t).trigger("drconnect-carterror",[e]),e})},addLineItemToCartById:function(e,t,i){var s=this,o=[n.getProductResourceURL(),e].join("/");t=t||1;if($(s).triggerHandler("drconnect-beforeaddproduct",[o])!==!1)return s.list(o).then(function(o){return o.product&&o.product.variations&&o.product.variations.product?r(i):s.post(n.getLineItemUrl(),{productId:e,quantity:t}).then(function(e){return s.getActiveCart()},function(e){throw e.message="Unable to Add Item to cart",$(s).trigger("drconnect-carterror",[e]),e})},function(e){throw e.message="Unable to Add Item to cart",$(s).trigger("drconnect-carterror",[e]),e})},updateQuantity:function(e,t){var r=this,i=[n.getCartResourceUrl(),"line-items",e].join("/");if($(r).triggerHandler("drconnect-beforequantityupdate",[t,e])!==!1)return r.post(i,{quantity:t,expand:"all"}).then(function(n){return $(r).trigger("drconnect-quantityupdate",[t,e]),r.getActiveCart()},function(e){throw $(r).trigger("drconnect-carterror",[e]),e})},removeLineItem:function(e){var t=this,r=[n.getCartResourceUrl(),"line-items",e].join("/");if($(t).triggerHandler("drconnect-beforeremoveitem",[e])!==!1)return t.remove(r).then(function(){return t.getActiveCart()},function(e){return t.getActiveCart()})},getWebCheckoutUrl:function(){return this._client.connect().then(function(e){return n.getWebCheckoutUrl()+"?token="+e},function(){return"Unable to checkout"})},clearCache:function(){s=null}});return o}),define("view/BaseView",["util/Class"],function(e){return e.extend({init:function(e){var t=this;t.setOptions(e),t.compileTemplates()},compileTemplates:function(){},setOptions:function(e){var t=this;t.options=$.extend({},t.getDefaults(),e)},getOptions:function(){var e=this;return e.options?e.options:{}},getOption:function(e){var t=this;return t.options[e]},setOption:function(e,t){var n=this;n.options[e]=t},getDefaults:function(){return{}}})}),define("view/CartView",["lib/underscore","view/BaseView"],function(e,t){function r(e){var t=this,n=t.getOptions();$(n.summaryElementSelector).append(t.summaryTemplate(e))}function i(){var t=this,n=t.getOptions(),r=$('<div class="connect-cart-wrapper"></div>').appendTo(n.cartElementSelector),i,s,o,u,a,f;i=$("#drMiniCartHeaderTemplate"),i.length?i=i.get(0).html():i=e.template(n.cartHeaderTemplate),r.prepend(i),e.each(n.currency,function(e){$option=$('<option value="'+e+'">'+e+"</option>"),e===n.defaultCurrency&&$option.attr("selected","selected"),r.find(".connect-cart-currencyselector").append($option)}),s=$("#drMiniCartBodyTemplate"),s.length?(f=n.emptyCartTemplate,bodyTemplateHTML=s.get(0).html()):(f=n.emptyCartTemplate,s=e.template(n.bodyTemplate,{emptyCartMessage:f})),r.append(s),o=$("#drMiniCartTotalTemplate"),o.length?o=o.get(0).html():o=e.template(n.totalsTemplate),r.append(o),u=$("#drMiniCartCouponTemplate"),u.length?u=u.get(0).html():u=e.template(n.couponTemplate),r.append(u),a=$("#drMiniCartFooterTemplate"),a.length?a=e.template(a.html()):a=e.template(n.footerTemplate),r.append(a)}var n={summaryTemplate:'<div class="connect-cart-summary"><h3><span>Shopping Cart</span> (<span class="connect-cart-quantity"><%= qty %></span>)</h3></div>',cartTemplate:'<div id="drMiniCart" class="connect-mini-cart"></div>',cartHeaderTemplate:'<div class="connect-cart-header">   <div class="connect-cart-feedback"></div>   <div class="connect-cart-currency">       <label for="drCartCurrencySelector">Currency:</label>       <select id="drCartCurrencySelector" class="connect-cart-currencyselector">       </select>   </div></div><div class="connect-cart-offerheader"></div>',bodyTemplate:'<div class="connect-cart-body connect-loading">   <div class="connect-cart-loadingmask">      <span class="connect-spinner"></span>   </div>   <div class="connect-content">       <%= emptyCartMessage %>   </div></div>',emptyCartTemplate:"<p>Your Shopping Cart is empty.</p>",totalsTemplate:'<div class="connect-cart-totals">   <div class="connect-cart-subtotal">       <span>Subtotal:</span><span class="amount">0.00</span></div>   <div class="connect-fine-print">       <span>Excludes tax and shipping</span>   </div></div>',couponTemplate:'<div class="connect-cart-couponwrapper connect-widget-button">    <input id="couponCode" class="connect-widget-couponcode" type="text" value="" placeholder="Enter Coupon Code"/>    <a class="connect-cart-applycoupon" disabled="disabled" href="#">        <i class="icon-ok-sign"></i> Apply Code    </a></div>',footerTemplate:'<div class="connect-cart-footer">    <div class="connect-widget-link">        <a href="#" class="connect-cart-showcode">Have a Promo Code?</a>    </div>    <div class="connect-widget-button right">        <a href="#" class="connect-cart-checkout"><i class="icon-shopping-cart icon"></i> Checkout</a>    </div>    <div class="connect-widget-clearfix"></div></div>',offerHeaderTemplate:"<span><%= offerHeader %></span>",offerTemplate:'<div class="connect-cart-offer"><p class="connect-cart-title"><%= product.displayName %></p><% if (pricing && (pricing.listPrice.value > pricing.salePriceWithQuantity.value)) { %><p><img class="connect-cart-image" src="<%= product.thumbnailImage %>" alt=""/><span class="connect-cart-pricing"><span>Regular Price: </span><span class="connect-widget-strikethrough"><del><%= pricing.formattedListPrice %></del></span></span><span class="connect-cart-pricing"><span>Promo Price: </span><span><%= pricing.formattedSalePriceWithQuantity %></span></span><%} else { %><p><img class="connect-cart-image" src="<%= product.thumbnailImage %>" alt=""/><span class="connect-cart-pricing"><%= pricing.formattedSalePriceWithQuantity %></span><% } %><div class="connect-widget-button"><a class="connect-cart-buy" data-value="<%= addProductToCart.uri %>" href="<%= addProductToCart.uri %>"><i class="icon-plus-sign"></i> Add</a></div></p><div style="line-height: 1; clear: both;"></div></div>',productTemplate:'<div class="connect-cart-lineitem"><p class="connect-cart-title" title="<%= product.shortDescription %>"><%= product.displayName %></p><img src="<%= product.thumbnailImage %>"/><div><span>Quantity: </span>   <input autocomplete="off" type="text" class="connect-cart-quantity" data-lineitem-id="<%= id %>" value="<%= quantity %>"<% if (product.inventoryStatus && product.inventoryStatus.maxOrderQuantity !== undefined){ %> data-maxorderquantity=<%=product.inventoryStatus.maxOrderQuantity%><%} %>/>   <span class="connect-widget-button"><a class="connect-cart-updatebtn" href="#"><i class="icon-refresh"></i></a></span></div><ul><li class="connect-cart-remove"><span><a href="#" data-lineitem-id="<%= id %>"><i class="icon-remove"></i> Remove</a></span></li><li class="connect-cart-sku"><span class="connect-cart-label">SKU: <%= product.sku %></span></li><li class="connect-lineitem-pricing"><span class="connect-cart-label">Price: </span><% if (pricing.listPriceWithQuantity.value > pricing.salePriceWithQuantity.value) { %> <span class="connect-widget-strikethrough"><%= pricing.formattedListPriceWithQuantity %>&nbsp;</span><%}%><span class="connect-lineitem-saleprice"><%= pricing.formattedSalePriceWithQuantity %></span></li></ul><div style="line-height: 1; clear: both;">&nbsp;</div></div>',subtotalTemplate:'<% if (discount.value && discount.value > 0) { %><div class="connect-cart-orderdiscount"><span>Discount: </span><span class="amount">-<%= formattedDiscount %></span></div> <%}%><% if (shippingAndHandling.value != null) { %><div class="connect-cart-orderdiscount"><span>Estimated Shipping: </span><span class="amount"><%= formattedShippingAndHandling %></span></div> <%}%><div class="connect-cart-subtotal"><span>Subtotal: </span><span class="amount"><%= formattedOrderTotal %></span></div><div class="connect-fine-print"><span>Excludes tax</span></div>',feedbackTemplate:'<p><i class="icon-ok-sign"></i> <%= msg %></p>',errorTemplate:'<p><i class="icon-warning-sign"></i> <%= msg %></p>',summaryElementSelector:"#drMiniCartSummary",cartElementSelector:"#drMiniCart",currency:["USD"],defaultCurrency:"USD"};return t.extend({init:function(e){var t=this,n;t._super.apply(t,arguments),r.call(t,{qty:0,subtotal:"0.0"}),i.call(t),n=$(t.getOption("cartElementSelector")),n.on("change",".connect-cart-currencyselector",function(){var e=$(this).val();$(t).trigger("drconnect-changecurrency",[e])}),n.find(".connect-cart-showcode").on("click",function(e){e.preventDefault(),$(this).hide(),n.find(".connect-cart-couponwrapper").show().find("> input").select().focus()}),$("#couponCode").on("keypress paste",function(){var e=$(this);(e.val()!==""||e.val()!=null)&&e.parent(".connect-cart-couponwrapper").find('>a[class^="connect-"]').removeAttr("disabled")})},getDefaults:function(){return n},compileTemplates:function(){var t=this;t.compileSummaryTemplate(),t.compileCartOfferTemplate(),t.offerHeaderTemplate=e.template(t.getOption("offerHeaderTemplate")),t.compileProductTemplate(),t.compileSubtotalTemplate(),t.feedbackTemplate=e.template(t.getOption("feedbackTemplate")),t.errorTemplate=e.template(t.getOption("errorTemplate")),t.emptyCartTemplate=e.template(t.getOption("emptyCartTemplate"))},compileSummaryTemplate:function(){var t=this,n=$("#drMiniCartSummaryTemplate");n.length?t.summaryTemplate=e.template(n.html()):t.summaryTemplate=e.template(t.getOption("summaryTemplate"))},compileCartOfferTemplate:function(){var t=this,n=$("#drMiniCartOfferTemplate");n.length?t.cartOfferTemplate=e.template(n.html()):t.cartOfferTemplate=e.template(t.getOption("offerTemplate"))},compileProductTemplate:function(){var t=this,n=$("#drMiniCartProductTemplate");if(n.length){debugger;t.productTemplate=e.template(n.html())}else t.productTemplate=e.template(t.getOption("productTemplate"))},compileSubtotalTemplate:function(){var t=this,n=$("#drMiniCartSubtotalTemplate");n.length?t.subtotalTemplate=e.template(n.html()):t.subtotalTemplate=e.template(t.getOption("subtotalTemplate"))},setOptions:function(e){e.summaryElement&&(e.summaryElementSelector="#"+e.summaryElement),e.cartElement&&(e.cartElementSelector="#"+e.cartElement),this._super.apply(this,[e])},updateCartSummary:function(e){var t=this,n=$(t.getOption("summaryElementSelector")),r={},i;r.qty=e.totalItemsInCart||"0",e.pricing!=null?r.subtotal=e.pricing.formattedOrderTotal:r.subtotal="0.0",n.length&&(i=t.summaryTemplate(r),n.html(i))},updateCart:function(e,t){var n=this,r=$(n.getOption("cartElementSelector"));e.lineItems&&e.lineItems.lineItem&&e.lineItems.lineItem.length?n.showLineItems(r,e):t.then(function(e){n.showEmptyCartOffers(r,e)}),$(n).trigger("drconnect-cartrender")},showLineItems:function(e,t){var n=this,r=[];e.find(".connect-cart-offerheader").hide().end().find(".connect-cart-totals").show().end().find(".connect-cart-footer").show().find(".connect-cart-showcode").show();try{r=t.lineItems.lineItem||[]}catch(i){}n.renderLineItems(e,r),n.setupEventListeners(e),n.updateCartSubtotal(t),$(n).trigger("drconnect-updatecart",[t])},renderLineItems:function(t,n){var r=this,i="";e.each(n,function(e){var t,n,s;if(e&&e.product!==undefined&&e.product.inventoryStatus!==undefined){t=e.product,n=e.product.inventoryStatus,s=parseInt(n.availableQuantity,10),isNaN(s)||(n.availableQuantity=s);if(t.maxOrderQuantity!==undefined)n.maxOrderQuantity=t.maxOrderQuantity;else if(n.productIsAllowsBackorders==="false"||n.productIsAllowsBackorders===!1)n.maxOrderQuantity=s-e.quantity;n.minOrderQuantity=t.minOrderQuantity||0}i+=r.productTemplate(e)}),t.find(".connect-cart-body .connect-content").empty().html(i).end()},setupEventListeners:function(e){var t=this;e.hasClass("initialized")||e.addClass("initialized").on("keypress",'input[type="text"]',function(e){e.keyCode===13&&$(t).trigger("drconnect-updatequantity",[this.value,this]),e.stopImmediatePropagation()}).on("click",".connect-cart-remove a",function(e){e.preventDefault(),$(t).trigger("drconnect-remove",[this])}).on("click",".connect-cart-applycoupon",function(){if(!$(this).attr("disabled")&&!$(this).hasClass("disabled")){var e=$("#couponCode").get(0);$(t).trigger("drconnect-applycoupon",[e,this])}return!1}).on("click",".connect-cart-buy",function(e){e.preventDefault();var n=this.value||this.href;$(t).trigger("drconnect-addtocart",[{value:n},this])}).on("click",".connect-cart-updatebtn",function(){var e=$(this),n;return!e.attr("disabled")&&!e.hasClass("disabled")&&(n=e.siblings('input[type="text"]'),n.length&&n.val()>-1&&$(t).trigger("drconnect-updatequantity",[n.val(),n.get(0)])),!1})},updateCartSubtotal:function(e){var t=this,n=e.pricing,r=$(t.getOption("cartElementSelector"));n&&n.formattedOrderTotal!=null?(n.discount&&typeof n.discount.value=="string"&&(isNaN(parseInt(n.discount.value,10))||(n.discount.value=parseInt(n.discount.value,10))),n.shippingAndHandling&&typeof n.shippingAndHandling.value=="string"&&(isNaN(parseInt(n.shippingAndHandling.value,10))||(n.shippingAndHandling.value=parseInt(n.shippingAndHandling.value,10))),r.find(".connect-cart-totals").empty().html(t.subtotalTemplate(n))):(n={formattedOrderTotal:"0.00",discount:{value:0},shippingAndHandling:{value:0}},r.find(".connect-cart-totals").empty().html(t.subtotalTemplate(n)))},showEmptyCartOffers:function(e,t){var n=this;n.renderEmptyOffers(e,t),e.find(".connect-cart-totals").hide().end().find(".connect-cart-couponwrapper").hide().end().find(".connect-cart-footer").hide(),n.setupEventListeners(e),$(n).trigger("drconnect-updatecart",[t])},renderEmptyOffers:function(e,t){var n=this,r="",i=[],s,o;try{i=t.productOffers.productOffer}catch(u){}if(i.length){t.salesPitch[0]&&e.find(".connect-cart-offerheader").show().html(n.offerHeaderTemplate({offerHeader:t.salesPitch[0]}));for(s=0,o=i.length;s<o;s+=1)r+=n.cartOfferTemplate(i[s])}else r=n.emptyCartTemplate();e.find(".connect-cart-body .connect-content").empty().html(r).end()},hideCouponEntry:function(){var e=this,t=this.getOptions(),n;n=$(t.cartElementSelector),n.find(".connect-cart-couponwrapper").hide().find('>a[class^="connect-"]').attr("disabled","disabled"),n.find(".connect-cart-showcode").show()},setCurrency:function(e){var t=this,n=$(t.getOption("cartElementSelector")),r;r=n.find(".connect-cart-currencyselector"),r.val(e)},blockCartUI:function(){var e=this,t=$(e.getOption("cartElementSelector"));t.find(".connect-cart-body").addClass("connect-loading").find(".connect-content").scrollTop(0).end().find(".connect-cart-currencyselector").attr("disabled","disabled")},unblockCartUI:function(){var e=this,t=e.getOptions(),n;n=$(e.getOption("cartElementSelector")).find(".connect-cart-body").removeClass("connect-loading").find(".connect-content").scrollTop(0).end().find(".connect-cart-currencyselector").removeAttr("disabled")},showFeedback:function(e,t){var n=this,r,i=$(n.getOption("cartElementSelector")),s=i.find(".connect-cart-feedback");t=!!t,r=t?n.errorTemplate({msg:e}):n.feedbackTemplate({msg:e}),n.feedbackTO!==null?(clearTimeout(n.feedbackTO),n.feedbackTO=null,n.hideFeedback(function(){s.toggleClass("connect-cart-error",t).html(r).fadeIn()})):s.toggleClass("connect-cart-error",t).html(r).fadeIn(),n.feedbackTO=setTimeout(function(){n.hideFeedback()},5e3)},hideFeedback:function(e){var t=this,n=$(t.getOption("cartElementSelector"));n.find(".connect-cart-feedback").fadeOut(function(){typeof e=="function"&&e.call(this)})},getCartElement:function(){return $(this.getOption("cartElementSelector"))}})}),define("dr-minicart",["api/Client","config","service/CartService","view/CartView","util/Class"],function(e,t,n,r,i){function o(e,t,n){var r=/\/?ProductID[=\.](\d+)\/?/i,i=/\/?Quantity[=\.](\d+)\/?/i;n===undefined&&(n=document),$(s,n).each(function(){var n=this.href.match(r)[1],s=i.test(this.href)?RegExp.$1:"1";$(this).on("click",function(r){var i=$(this);r.preventDefault(),i.addClass("disabled"),t.addLineItemToCartById(n,s,i.attr("href")).then(function(n){typeof n=="string"?window.location.href=n:(e.updateCartSummary(n),e.updateCart(n,t.getEmptyCartOffer()),i.removeClass("disabled"),e.showFeedback("Item added to cart"))},function(t){i.removeClass("disabled"),e.showFeedback(t.message,!0)})})})}var s='a[href*="AddItemToRequisition"],area[href*="AddItemToRequisition"],a[href*="/store/"][href*="/buy/"][href*="/productID."],area[href*="/store/"][href*="/buy/"][href*="/productID."]';return i.extend({defaults:{summaryElement:"drMiniCartSummary",cartElement:"drMiniCart",rewriteLinks:!0},init:function(t){var i=this,s,u,a,f;i.setOptions(t),a=i.getOptions(),a.client&&a.client instanceof e?i.client=a.client:a.apiKey&&(i.client=new e(a.apiKey)),s=new n(i.client),u=new r(t),a.rewriteLinks!==!1&&o.call(i,u,s),$(s).on("drconnect-beforeaddproduct drconnect-beforeremoveitem drconnect-beforequantityupdate drconnect-beforeapplycode",function(){u.blockCartUI()}).on("drconnect-carterror",function(){u.unblockCartUI()}),f=u.getCartElement(),$(u).on("drconnect-addtocart",function(e,t){s.addLineItemToCart(t.value).then(function(e){u.showFeedback("Item added to cart."),u.updateCartSummary(e),u.updateCart(e,s.getEmptyCartOffer()),f.trigger("drconnect-addtocart",[e])},function(e){u.showFeedback(e.message,!0)})}).on("drconnect-updatequantity",function(e,t,n){var r=$(n).attr("data-lineitem-id");t!==n.defaultValue&&(!isNaN(t-0)&&t-0>0?r&&(f.trigger("drconnect-updatequantity",[r,t,n]),s.updateQuantity(r,t).then(function(e){u.showFeedback("Quantity Updated"),u.updateCartSummary(e),u.updateCart(e,s.getEmptyCartOffer())},function(e){u.showFeedback("Unable to Update",!0),n.value=n.defaultValue})):(u.showFeedback("Please enter a number greater than zero",!0),n.value=n.defaultValue))}).on("drconnect-remove",function(e,t){var n=$(t).attr("data-lineitem-id");n&&s.removeLineItem(n).then(function(e){f.trigger("drconnect-remove",[n]),u.showFeedback("Item removed"),u.updateCartSummary(e),u.updateCart(e,s.getEmptyCartOffer())})}).on("drconnect-updatecart",function(e,t){u.unblockCartUI(),f.trigger("drconnect-updatecart",[t])}).on("drconnect-changecurrency",function(e,t){u.blockCartUI(),i.client.updateShopper({currency:t}).then(function(){f.trigger("drconnect-changecurrency",[t]),u.showFeedback("Currency Settings Updated");return},function(){u.showFeedback("Unable to update Currenct Settings",!0);return}).done(function(){s.clearCache(),s.getActiveCart().then(function(e){u.updateCartSummary(e),u.updateCart(e,s.getEmptyCartOffer())})})}).on("drconnect-applycoupon",function(e,t,n){var r=$(t).val();r!=null&&s.applyCouponCode(r).then(function(e){u.showFeedback("Coupon code applied. Final price will be determined at checkout."),$(t).val(""),u.updateCartSummary(e),u.updateCart(e,s.getEmptyCartOffer()),u.hideCouponEntry()})}).on("drconnect-cartrender",function(e){f.trigger("drconnect-cartrender")}),$(".connect-cart-checkout").on("click",function(){s.getWebCheckoutUrl().then(function(e){window.location=e})}),this.start(u,s)},start:function(e,n){var r=this;e.blockCartUI(),n.getActiveCart().then(function(i){i.pricing&&i.pricing.orderTotal?(e.updateCartSummary(i),e.updateCart(i,n.getEmptyCartOffer()),e.setCurrency(i.pricing.orderTotal.currency)):r.client.shopperService.list().then(function(s){s.currency?(e.updateCartSummary(i),e.updateCart(i,n.getEmptyCartOffer()),e.setCurrency(s.currency)):(e.setCurrency(t.getDefaultCurrency()),r.client.updateShopper({currency:t.getDefaultCurrency(),locale:t.getDefaultLocale()}).then(function(t){e.updateCartSummary(i),e.updateCart(i,n.getEmptyCartOffer())}))})})},setOptions:function(e){var n=this;n.options=$.extend({},e),n.options.emptyOfferId&&t.setEmptyOfferId(n.options.emptyOfferId),n.options.emptyOfferPop&&t.setEmptyOfferPop(n.options.emptyOfferPop),n.options.siteId&&t.setSiteId(n.options.siteId),n.options.vanityDomain&&t.setVanityDomain(n.options.vanityDomain)},getOptions:function(){return this.options},setOption:function(e,t){this.options[e]=t},getOption:function(e){return this.options[e]}})});